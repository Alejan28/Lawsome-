{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect } from 'react';\nimport { db, storage } from '../InitApp/firebase';\nimport { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from 'firebase/firestore';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nexport const useChatHistory = userId => {\n  _s();\n  const [history, setHistory] = useState([]);\n  const [loading, setLoading] = useState(true);\n  useEffect(() => {\n    if (!userId) {\n      setHistory([]);\n      setLoading(false);\n      return;\n    }\n\n    // Use a subcollection for better security and organization: users/{userId}/chat_history\n    const q = query(collection(db, 'users', userId, 'chat_history'), orderBy('timestamp', 'asc'));\n    const unsubscribe = onSnapshot(q, snapshot => {\n      const msgs = snapshot.docs.map(doc => ({\n        id: doc.id,\n        ...doc.data()\n      }));\n      setHistory(msgs);\n      setLoading(false);\n    }, error => {\n      console.error(\"Error fetching chat history:\", error);\n      setLoading(false);\n    });\n    return () => unsubscribe();\n  }, [userId]);\n  const saveMessage = async message => {\n    if (!userId) return;\n    let fileUrl = null;\n    if (message.fileBlob) {\n      try {\n        const storageRef = ref(storage, `chat_files/${userId}/${Date.now()}_document.docx`);\n        await uploadBytes(storageRef, message.fileBlob);\n        fileUrl = await getDownloadURL(storageRef);\n      } catch (error) {\n        console.error(\"Error uploading file:\", error);\n      }\n    }\n    try {\n      await addDoc(collection(db, 'users', userId, 'chat_history'), {\n        text: message.text,\n        sender: message.sender,\n        timestamp: serverTimestamp(),\n        fileUrl: fileUrl || null\n      });\n    } catch (error) {\n      console.error(\"Error saving message:\", error);\n    }\n  };\n  return {\n    history,\n    loading,\n    saveMessage\n  };\n};\n_s(useChatHistory, \"Ieukcr00HhsUBPlfQ8IG0OBl+dQ=\");","map":{"version":3,"names":["useState","useEffect","db","storage","collection","query","orderBy","onSnapshot","addDoc","serverTimestamp","ref","uploadBytes","getDownloadURL","useChatHistory","userId","_s","history","setHistory","loading","setLoading","q","unsubscribe","snapshot","msgs","docs","map","doc","id","data","error","console","saveMessage","message","fileUrl","fileBlob","storageRef","Date","now","text","sender","timestamp"],"sources":["C:/Users/40741/IdeaProjects/lawsome-app/src/hooks/useChatHistory.js"],"sourcesContent":["import { useState, useEffect } from 'react';\r\nimport { db, storage } from '../InitApp/firebase';\r\nimport { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\n\r\nexport const useChatHistory = (userId) => {\r\n    const [history, setHistory] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        if (!userId) {\r\n            setHistory([]);\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        // Use a subcollection for better security and organization: users/{userId}/chat_history\r\n        const q = query(\r\n            collection(db, 'users', userId, 'chat_history'),\r\n            orderBy('timestamp', 'asc')\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const msgs = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }));\r\n            setHistory(msgs);\r\n            setLoading(false);\r\n        }, (error) => {\r\n            console.error(\"Error fetching chat history:\", error);\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [userId]);\r\n\r\n    const saveMessage = async (message) => {\r\n        if (!userId) return;\r\n\r\n        let fileUrl = null;\r\n        if (message.fileBlob) {\r\n            try {\r\n                const storageRef = ref(storage, `chat_files/${userId}/${Date.now()}_document.docx`);\r\n                await uploadBytes(storageRef, message.fileBlob);\r\n                fileUrl = await getDownloadURL(storageRef);\r\n            } catch (error) {\r\n                console.error(\"Error uploading file:\", error);\r\n            }\r\n        }\r\n\r\n        try {\r\n            await addDoc(collection(db, 'users', userId, 'chat_history'), {\r\n                text: message.text,\r\n                sender: message.sender,\r\n                timestamp: serverTimestamp(),\r\n                fileUrl: fileUrl || null\r\n            });\r\n        } catch (error) {\r\n            console.error(\"Error saving message:\", error);\r\n        }\r\n    };\r\n\r\n    return { history, loading, saveMessage };\r\n};\r\n"],"mappings":";AAAA,SAASA,QAAQ,EAAEC,SAAS,QAAQ,OAAO;AAC3C,SAASC,EAAE,EAAEC,OAAO,QAAQ,qBAAqB;AACjD,SAASC,UAAU,EAAEC,KAAK,EAAEC,OAAO,EAAEC,UAAU,EAAEC,MAAM,EAAEC,eAAe,QAAQ,oBAAoB;AACpG,SAASC,GAAG,EAAEC,WAAW,EAAEC,cAAc,QAAQ,kBAAkB;AAEnE,OAAO,MAAMC,cAAc,GAAIC,MAAM,IAAK;EAAAC,EAAA;EACtC,MAAM,CAACC,OAAO,EAAEC,UAAU,CAAC,GAAGjB,QAAQ,CAAC,EAAE,CAAC;EAC1C,MAAM,CAACkB,OAAO,EAAEC,UAAU,CAAC,GAAGnB,QAAQ,CAAC,IAAI,CAAC;EAE5CC,SAAS,CAAC,MAAM;IACZ,IAAI,CAACa,MAAM,EAAE;MACTG,UAAU,CAAC,EAAE,CAAC;MACdE,UAAU,CAAC,KAAK,CAAC;MACjB;IACJ;;IAEA;IACA,MAAMC,CAAC,GAAGf,KAAK,CACXD,UAAU,CAACF,EAAE,EAAE,OAAO,EAAEY,MAAM,EAAE,cAAc,CAAC,EAC/CR,OAAO,CAAC,WAAW,EAAE,KAAK,CAC9B,CAAC;IAED,MAAMe,WAAW,GAAGd,UAAU,CAACa,CAAC,EAAGE,QAAQ,IAAK;MAC5C,MAAMC,IAAI,GAAGD,QAAQ,CAACE,IAAI,CAACC,GAAG,CAACC,GAAG,KAAK;QACnCC,EAAE,EAAED,GAAG,CAACC,EAAE;QACV,GAAGD,GAAG,CAACE,IAAI,CAAC;MAChB,CAAC,CAAC,CAAC;MACHX,UAAU,CAACM,IAAI,CAAC;MAChBJ,UAAU,CAAC,KAAK,CAAC;IACrB,CAAC,EAAGU,KAAK,IAAK;MACVC,OAAO,CAACD,KAAK,CAAC,8BAA8B,EAAEA,KAAK,CAAC;MACpDV,UAAU,CAAC,KAAK,CAAC;IACrB,CAAC,CAAC;IAEF,OAAO,MAAME,WAAW,CAAC,CAAC;EAC9B,CAAC,EAAE,CAACP,MAAM,CAAC,CAAC;EAEZ,MAAMiB,WAAW,GAAG,MAAOC,OAAO,IAAK;IACnC,IAAI,CAAClB,MAAM,EAAE;IAEb,IAAImB,OAAO,GAAG,IAAI;IAClB,IAAID,OAAO,CAACE,QAAQ,EAAE;MAClB,IAAI;QACA,MAAMC,UAAU,GAAGzB,GAAG,CAACP,OAAO,EAAE,cAAcW,MAAM,IAAIsB,IAAI,CAACC,GAAG,CAAC,CAAC,gBAAgB,CAAC;QACnF,MAAM1B,WAAW,CAACwB,UAAU,EAAEH,OAAO,CAACE,QAAQ,CAAC;QAC/CD,OAAO,GAAG,MAAMrB,cAAc,CAACuB,UAAU,CAAC;MAC9C,CAAC,CAAC,OAAON,KAAK,EAAE;QACZC,OAAO,CAACD,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;MACjD;IACJ;IAEA,IAAI;MACA,MAAMrB,MAAM,CAACJ,UAAU,CAACF,EAAE,EAAE,OAAO,EAAEY,MAAM,EAAE,cAAc,CAAC,EAAE;QAC1DwB,IAAI,EAAEN,OAAO,CAACM,IAAI;QAClBC,MAAM,EAAEP,OAAO,CAACO,MAAM;QACtBC,SAAS,EAAE/B,eAAe,CAAC,CAAC;QAC5BwB,OAAO,EAAEA,OAAO,IAAI;MACxB,CAAC,CAAC;IACN,CAAC,CAAC,OAAOJ,KAAK,EAAE;MACZC,OAAO,CAACD,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;IACjD;EACJ,CAAC;EAED,OAAO;IAAEb,OAAO;IAAEE,OAAO;IAAEa;EAAY,CAAC;AAC5C,CAAC;AAAChB,EAAA,CA3DWF,cAAc","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
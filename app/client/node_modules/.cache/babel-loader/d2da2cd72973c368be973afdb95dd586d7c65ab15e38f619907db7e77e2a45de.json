{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect } from 'react';\nimport { db, storage } from '../InitApp/firebase';\nimport { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from 'firebase/firestore';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nexport const useChatHistory = userId => {\n  _s();\n  const [history, setHistory] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [usingLocal, setUsingLocal] = useState(false);\n  useEffect(() => {\n    if (!userId) {\n      setHistory([]);\n      setLoading(false);\n      return;\n    }\n\n    // Try to load from Firestore\n    const q = query(collection(db, 'users', userId, 'chat_history'), orderBy('timestamp', 'asc'));\n    const unsubscribe = onSnapshot(q, snapshot => {\n      const msgs = snapshot.docs.map(doc => ({\n        id: doc.id,\n        ...doc.data()\n      }));\n      setHistory(msgs);\n      setLoading(false);\n      setUsingLocal(false);\n    }, error => {\n      console.warn(\"Firestore access failed (likely permissions). Falling back to localStorage.\", error);\n      setUsingLocal(true);\n\n      // Load from localStorage\n      try {\n        const localData = localStorage.getItem(`chat_history_${userId}`);\n        if (localData) {\n          setHistory(JSON.parse(localData));\n        } else {\n          setHistory([]);\n        }\n      } catch (e) {\n        console.error(\"Error reading localStorage:\", e);\n      }\n      setLoading(false);\n    });\n    return () => unsubscribe();\n  }, [userId]);\n  const saveMessage = async message => {\n    if (!userId) return;\n    let fileUrl = null;\n    // Try to upload file if present\n    if (message.fileBlob) {\n      try {\n        const storageRef = ref(storage, `chat_files/${userId}/${Date.now()}_document.docx`);\n        await uploadBytes(storageRef, message.fileBlob);\n        fileUrl = await getDownloadURL(storageRef);\n      } catch (error) {\n        console.error(\"Error uploading file (likely permissions):\", error);\n        // If upload fails, we can't really generate a URL. \n        // We might want to convert blob to base64 for local storage? \n        // For now, just skip the URL.\n      }\n    }\n    const msgData = {\n      text: message.text,\n      sender: message.sender,\n      timestamp: usingLocal ? Date.now() : serverTimestamp(),\n      fileUrl: fileUrl || null\n    };\n    if (usingLocal) {\n      // Save to localStorage\n      const newHistory = [...history, {\n        ...msgData,\n        timestamp: Date.now()\n      }]; // Ensure timestamp is a number for local\n      setHistory(newHistory);\n      localStorage.setItem(`chat_history_${userId}`, JSON.stringify(newHistory));\n    } else {\n      // Save to Firestore\n      try {\n        await addDoc(collection(db, 'users', userId, 'chat_history'), msgData);\n      } catch (error) {\n        console.error(\"Error saving to Firestore, switching to local:\", error);\n        setUsingLocal(true);\n\n        // Fallback save\n        const newHistory = [...history, {\n          ...msgData,\n          timestamp: Date.now()\n        }];\n        setHistory(newHistory);\n        localStorage.setItem(`chat_history_${userId}`, JSON.stringify(newHistory));\n      }\n    }\n  };\n  return {\n    history,\n    loading,\n    saveMessage\n  };\n};\n_s(useChatHistory, \"N5IoLIqT0LDRZrNx2p/jv9t94rM=\");","map":{"version":3,"names":["useState","useEffect","db","storage","collection","query","orderBy","onSnapshot","addDoc","serverTimestamp","ref","uploadBytes","getDownloadURL","useChatHistory","userId","_s","history","setHistory","loading","setLoading","usingLocal","setUsingLocal","q","unsubscribe","snapshot","msgs","docs","map","doc","id","data","error","console","warn","localData","localStorage","getItem","JSON","parse","e","saveMessage","message","fileUrl","fileBlob","storageRef","Date","now","msgData","text","sender","timestamp","newHistory","setItem","stringify"],"sources":["C:/Users/40741/IdeaProjects/lawsome-app/src/hooks/useChatHistory.js"],"sourcesContent":["import { useState, useEffect } from 'react';\r\nimport { db, storage } from '../InitApp/firebase';\r\nimport { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\r\n\r\nexport const useChatHistory = (userId) => {\r\n    const [history, setHistory] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [usingLocal, setUsingLocal] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (!userId) {\r\n            setHistory([]);\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        // Try to load from Firestore\r\n        const q = query(\r\n            collection(db, 'users', userId, 'chat_history'),\r\n            orderBy('timestamp', 'asc')\r\n        );\r\n\r\n        const unsubscribe = onSnapshot(q, (snapshot) => {\r\n            const msgs = snapshot.docs.map(doc => ({\r\n                id: doc.id,\r\n                ...doc.data()\r\n            }));\r\n            setHistory(msgs);\r\n            setLoading(false);\r\n            setUsingLocal(false);\r\n        }, (error) => {\r\n            console.warn(\"Firestore access failed (likely permissions). Falling back to localStorage.\", error);\r\n            setUsingLocal(true);\r\n            \r\n            // Load from localStorage\r\n            try {\r\n                const localData = localStorage.getItem(`chat_history_${userId}`);\r\n                if (localData) {\r\n                    setHistory(JSON.parse(localData));\r\n                } else {\r\n                    setHistory([]);\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Error reading localStorage:\", e);\r\n            }\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [userId]);\r\n\r\n    const saveMessage = async (message) => {\r\n        if (!userId) return;\r\n\r\n        let fileUrl = null;\r\n        // Try to upload file if present\r\n        if (message.fileBlob) {\r\n            try {\r\n                const storageRef = ref(storage, `chat_files/${userId}/${Date.now()}_document.docx`);\r\n                await uploadBytes(storageRef, message.fileBlob);\r\n                fileUrl = await getDownloadURL(storageRef);\r\n            } catch (error) {\r\n                console.error(\"Error uploading file (likely permissions):\", error);\r\n                // If upload fails, we can't really generate a URL. \r\n                // We might want to convert blob to base64 for local storage? \r\n                // For now, just skip the URL.\r\n            }\r\n        }\r\n\r\n        const msgData = {\r\n            text: message.text,\r\n            sender: message.sender,\r\n            timestamp: usingLocal ? Date.now() : serverTimestamp(),\r\n            fileUrl: fileUrl || null\r\n        };\r\n\r\n        if (usingLocal) {\r\n            // Save to localStorage\r\n            const newHistory = [...history, { ...msgData, timestamp: Date.now() }]; // Ensure timestamp is a number for local\r\n            setHistory(newHistory);\r\n            localStorage.setItem(`chat_history_${userId}`, JSON.stringify(newHistory));\r\n        } else {\r\n            // Save to Firestore\r\n            try {\r\n                await addDoc(collection(db, 'users', userId, 'chat_history'), msgData);\r\n            } catch (error) {\r\n                console.error(\"Error saving to Firestore, switching to local:\", error);\r\n                setUsingLocal(true);\r\n                \r\n                // Fallback save\r\n                const newHistory = [...history, { ...msgData, timestamp: Date.now() }];\r\n                setHistory(newHistory);\r\n                localStorage.setItem(`chat_history_${userId}`, JSON.stringify(newHistory));\r\n            }\r\n        }\r\n    };\r\n\r\n    return { history, loading, saveMessage };\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}